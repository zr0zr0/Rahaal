<html><head><base href="." /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Ø±Ø­Ø§Ù„ - Ø®Ø¯Ù…Ø© Ø§Ø­ØªØ³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‚Ù„</title>
<meta name="description" content="Ø±Ø­Ø§Ù„ - Ø®Ø¯Ù…Ø© Ø§Ø­ØªØ³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„ÙŠÙ…Ù†" />
<meta name="keywords" content="Ø±Ø­Ø§Ù„, ØªÙƒØ³ÙŠ, Ù†Ù‚Ù„, Ø³ÙŠØ§Ø±Ø§Øª Ø£Ø¬Ø±Ø©, Ø§Ù„ÙŠÙ…Ù†" />
<meta name="author" content="Ø±Ø­Ø§Ù„" />

<!-- Open Graph Meta Tags -->
<meta property="og:title" content="Ø±Ø­Ø§Ù„ - Ø®Ø¯Ù…Ø© Ø§Ø­ØªØ³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‚Ù„" />
<meta property="og:description" content="Ø§Ø­Ø³Ø¨ ØªÙƒÙ„ÙØ© Ø±Ø­Ù„ØªÙƒ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø±Ø­Ø§Ù„ Ù„Ù„Ù†Ù‚Ù„ ÙÙŠ Ø§Ù„ÙŠÙ…Ù†" />
<meta property="og:image" content="https://i.ibb.co/3ybMn9k/Screenshot-Google-Play-Store.jpg" />
<meta property="og:url" content="https://rahaal.com" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Ø±Ø­Ø§Ù„" />
<meta property="og:locale" content="ar_SA" />
<link rel="shortcut icon" type="image/x-icon" href="https://i.ibb.co/3ybMn9k/Screenshot-Google-Play-Store.jpg">


<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Ø±Ø­Ø§Ù„ - Ø®Ø¯Ù…Ø© Ø§Ø­ØªØ³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‚Ù„" />
<meta name="twitter:description" content="Ø§Ø­Ø³Ø¨ ØªÙƒÙ„ÙØ© Ø±Ø­Ù„ØªÙƒ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø±Ø­Ø§Ù„ Ù„Ù„Ù†Ù‚Ù„ ÙÙŠ Ø§Ù„ÙŠÙ…Ù†" />
<meta name="twitter:image" content="https://i.ibb.co/3ybMn9k/Screenshot-Google-Play-Store.jpg" />

<!-- Favicon and Apple Touch Icons -->
<link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,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" />
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABXUExURUxpcfsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAg9cqBYAAAAcdFJOUwDvEL9AYCAwcI+/n1Cfj99g779AIN8QMHCvr6CQF8qSSQAAAfFJREFUOMtVU9mWwyAIBVwQd9T8/5deQNO0nfEhwYV7WQCiP6MxD4wxbxzUMTFIqUL/BqYI2t4LKaV45wNUxQshxmw9UERm732zWRBaa2MMpMGYOp7oQohpmrIsm6aR0oOHvHB+XVeMEec8WAPvYyQKGOtd14khTNNQDEp1BkI0CaHrOoAHPQChXZMQ51HgR+99Symjrus9z6Drvu+jNYjoPURd1ylFEUqhlPpxz3VFtPc8T4QgBG6dc98g9Pt2zXOMMfoV0LXWOWutlLKua2stF2Kex8fHZcxd9H6ORynHGA6+77uUwnl/7LhCUXqFKkEL59M0FaTM8/Pmfd4Cz+9sN0jA4LquWmulMtlSAgCw3fsjCaXUCPvYg4CkTBGFsyQEpKFzEIARhOHiLQshkCOJhJQSkPAeGSB46FxyXYQAz957v0JDygTIyFiglHLpOILmkxCkwSUQGR0aPwQnwBaMgZCmrBZa6+eQbQf6i4S1/bhtRTRiSgmSgBNcZG3C7uu2McY45x37RmaMYQ0RHv2IPkLeCFwBNTdG2YbLMXqIyKICKTj3BbYtpeM9v8WgLPMOfHScAw3TQNt2XQSRmSE0m8RoSXM+gIW+79sCAvL2e1IJ7qgcFc7vqbBZHutj5KBW588/AMJPd4AquTF8Yv4BzqEn1HqGw/8AAAAASUVORK5CYII=" />
<link rel="icon" type="image/png" sizes="16x16" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABXUExURUxpcfsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAvsCAg9cqBYAAAAcdFJOUwDvEL9AYCAwcI+/n1Cfj99g779AIN8QMHCvr6CQF8qSSQAAAJ9JREFUGNNNkFkSwyAIRUERNYtJ0/uf8wlm0vQzD+4dFkX5K2PMzBlomZkx0p2IhFJKiODWGwBoreGTAGCMQQihqioA3vveuySEYK3VWgcAxpgYo7UWEbPOeYwR3MwVxrQmREIIbJRSfd+jlHVVxRildYjovYcxxntvjEkpOedijG3bppSUUt57ay0A5Jwxxj3nPWfOmYi+X9d/9AA5mIhqZxEAAAAASUVORK5CYII=" />
<link rel="manifest" href="data:application/json;base64,ewogICAgIm5hbWUiOiAi2LHYrdin2YQiLAogICAgInNob3J0X25hbWUiOiAi2LHYrdin2YQiLAogICAgImljb25zIjogWwogICAgICAgIHsKICAgICAgICAgICAgInNyYyI6ICIvYW5kcm9pZC1jaHJvbWUtMTkyeDE5Mi5wbmciLAogICAgICAgICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgInNyYyI6ICIvYW5kcm9pZC1jaHJvbWUtNTEyeDUxMi5wbmciLAogICAgICAgICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgICAgICB9CiAgICBdLAogICAgInRoZW1lX2NvbG9yIjogIiM4QjAwMDAiLAogICAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIgp9" />

<!-- Apple Web App Meta -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Ø±Ø­Ø§Ù„" />

<!-- Microsoft Tiles -->
<meta name="msapplication-TileColor" content="#8B0000" />
<meta name="msapplication-config" content="data:application/xml;base64,PHhtbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJ1dGYtOCI/Pgo8YnJvd3Nlcmxpc3Q+CiAgPG1zdGlsZT4KICAgIDx0aWxlIGltZz0iL21zdGlsZS0xNDR4MTQ0LnBuZyIvPgogICAgPFRpbGVDb2xvcj4jOEIwMDAwPC9UaWxlQ29sb3I+CiAgPC9tc3RpbGU+CjwvYnJvd3Nlcmxpc3Q+" />

<!-- Theme Color for browsers -->
<meta name="theme-color" content="#8B0000" />
<!-- Add Leaflet CSS and Algolia Places CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/places.js@1.19.0/dist/places.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* Update font-face declaration for Cairo font */
@font-face {
  font-family: 'Cairo';
  src: url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
}

/* Apply Cairo font to all elements */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Cairo', sans-serif;
  direction: rtl;
}

/* Enhance typography for specific elements */
.vehicle-selection h2 {
  font-family: 'Cairo', sans-serif;
  font-weight: 700;
  font-size: 1.8rem;
  margin-bottom: 2rem;
}

.vehicle-option h3 {
  font-family: 'Cairo', sans-serif;
  font-weight: 600;
  font-size: 1.3rem;
  margin-bottom: 0.3rem;
}

.vehicle-option p {
  font-family: 'Cairo', sans-serif;
  font-weight: 400;
  font-size: 1rem;
  color: #666;
}

.search-input {
  font-family: 'Cairo', sans-serif;
  font-size: 1rem;
}

.search-btn,
.start-trip-btn,
.end-trip-btn,
.modal-button {
  font-family: 'Cairo', sans-serif;
  font-weight: 600;
}

.trip-details h3 {
  font-family: 'Cairo', sans-serif;
  font-weight: 700;
  margin-bottom: 1rem;
}

.trip-details p {
  font-family: 'Cairo', sans-serif;
  font-size: 1.1rem;
  margin-bottom: 0.5rem;
}

.modal-title {
  font-family: 'Cairo', sans-serif;
  font-weight: 700;
  font-size: 1.5rem;
}

.modal-message {
  font-family: 'Cairo', sans-serif;
  font-size: 1.1rem;
  line-height: 1.6;
}

/* Add better spacing for text elements */
.trip-summary .summary-item {
  font-family: 'Cairo', sans-serif;
  font-size: 1.1rem;
  padding: 1.2rem;
}

.location-error-title {
  font-family: 'Cairo', sans-serif;
  font-weight: 700;
  font-size: 1.4rem;
}

.location-error-message {
  font-family: 'Cairo', sans-serif;
  font-size: 1.1rem;
  line-height: 1.6;
}

:root {
  --primary-color: #8B0000;
  --secondary-color: #4A0404;
  --white: #FFFFFF;
  --light-gray: #F5F5F5;
  --dark-gray: #333333;
}

body {
  background: var(--light-gray);
}

.welcome-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.vehicle-selection {
  background: var(--white);
  padding: 2rem;
  border-radius: 15px;
  width: 90%;
  max-width: 600px;
}

.vehicle-option {
  display: flex;
  align-items: center;
  margin: 1rem 0;
  padding: 1rem;
  border: 2px solid var(--primary-color);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.vehicle-option:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.map-container {
  width: 100%;
  height: 100vh;
  z-index: 1;
}

.search-bar {
  position: fixed;
  bottom: 20px;
  right: 20px;
  left: 20px;
  background: var(--white);
  padding: 1rem;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  z-index: 2;
}

.search-container {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.search-input {
  width: 100%;
  padding: 0.8rem;
  border: 2px solid var(--primary-color);
  border-radius: 5px;
  font-size: 1rem;
}

.search-btn {
  background: var(--primary-color);
  color: var(--white);
  border: none;
  padding: 0.8rem;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  min-width: 100px;
}

.start-trip-btn {
  background: var(--primary-color);
  color: var(--white);
  border: none;
  padding: 0.8rem 2rem;
  border-radius: 5px;
  cursor: pointer;
  margin-top: 1rem;
  font-weight: bold;
  width: 100%;
}

.trip-status {
  background: var(--primary-color);
  color: var(--white);
  padding: 1rem;
  border-radius: 5px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 1rem;
}

.pulse-dot {
  width: 10px;
  height: 10px;
  background-color: var(--white);
  border-radius: 50%;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
  }
  70% {
      transform: scale(1);
      box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
  }
  100% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
  }
}

.trip-details {
  position: fixed;
  top: 20px;
  left: 20px; /* Changed from right: 20px to left: 20px */
  background: var(--white);
  padding: 1rem;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  display: none;
  z-index: 2;
  min-width: 250px; /* Added to ensure consistent width */
  text-align: right; /* Added to maintain right alignment of text */
}

.end-trip-btn {
  background: var(--secondary-color);
  color: var(--white);
  border: none;
  padding: 0.8rem 2rem;
  border-radius: 5px;
  cursor: pointer;
  margin-top: 1rem;
  font-weight: bold;
  width: 100%;
}

.animate-pulse {
  animation: pulse 2s infinite;
}

/* Add new styles for the trip completion modal */
.trip-completion-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 1000;
    width: 90%;
    max-width: 500px;
    display: none;
    animation: modalFadeIn 0.3s ease;
}

.modal-header {
    text-align: center;
    margin-bottom: 2rem;
}

.completion-icon {
    width: 60px;
    height: 60px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    margin: 1rem auto;
    animation: iconPop 0.5s ease;
}

.trip-summary {
    display: grid;
    gap: 1rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 1rem;
    background: #f8f8f8;
    border-radius: 10px;
}

.total-cost {
    background: var(--primary-color);
    color: white;
    font-size: 1.2em;
    font-weight: bold;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: translate(-50%, -60%); }
    to { opacity: 1; transform: translate(-50%, -50%); }
}

@keyframes iconPop {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* Algolia Places custom styles */
.ap-input-icon {
    right: auto;
    left: 10px;
}

.ap-suggestion {
    text-align: right;
    direction: rtl;
}

#searchResults {
    direction: rtl;
    z-index: 1000;
}

#searchResults div:hover {
    background-color: #f5f5f5;
}

/* Add these new styles for search results */
.search-results {
    position: absolute;
    top: 100%;
    right: 0;
    left: 0;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 8px;
    max-height: 300px;
    overflow-y: auto;
    display: none;
    z-index: 1000;
}

.search-result-item {
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-result-item:hover {
    background-color: #f5f5f5;
}

.location-icon {
    flex-shrink: 0;
}

.custom-div-icon {
    background: none;
    border: none;
}

/* Add these styles for the location error modal */
.location-error-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 1001;
    width: 90%;
    max-width: 400px;
    text-align: center;
    display: none;
    animation: modalPopIn 0.3s ease-out;
}

.location-error-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 1rem;
    background: #FFE0E0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.location-error-title {
    color: var(--primary-color);
    margin-bottom: 1rem;
    font-size: 1.2em;
    font-weight: bold;
}

.location-error-message {
    color: var(--dark-gray);
    margin-bottom: 1.5rem;
    line-height: 1.5;
}

.location-error-button {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 0.8rem 2rem;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s;
}

.location-error-button:hover {
    background: var(--secondary-color);
}

@keyframes modalPopIn {
    0% {
        transform: translate(-50%, -60%);
        opacity: 0;
    }
    100% {
        transform: translate(-50%, -50%);
        opacity: 1;
    }
}

/* Add styles for the notification modal */
.notification-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 1001;
    width: 90%;
    max-width: 400px;
    text-align: center;
    display: none;
    animation: modalPopIn 0.3s ease-out;
}

.modal-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 1rem;
    background: var(--primary-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-title {
    color: var(--primary-color);
    margin-bottom: 1rem;
    font-size: 1.2em;
    font-weight: bold;
}

.modal-message {
    color: var(--dark-gray);
    margin-bottom: 1.5rem;
    line-height: 1.5;
}

.modal-button {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 0.8rem 2rem;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    width: 100%;
    margin-top: 1.5rem;
    transition: background 0.3s;
}

.modal-button:hover {
    background: var(--secondary-color);
}

.driver-info input {
    font-family: 'Cairo', sans-serif;
    font-size: 1rem;
    padding: 0.8rem;
    border: 2px solid var(--primary-color);
    border-radius: 5px;
    width: 100%;
    margin-bottom: 1rem;
}

.driver-info input:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 5px rgba(139, 0, 0, 0.2);
}

/* Add these styles for rotation controls */
.leaflet-rotate-control {
    background: white;
    border: 2px solid rgba(0,0,0,0.2);
    background-clip: padding-box;
    border-radius: 5px;
    padding: 5px;
}

.leaflet-rotate-control button {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    display: block;
    font-size: 18px;
    color: #666;
}

.leaflet-rotate-control button:hover {
    color: #000;
}
</style>
</head>
<body>
<div class="welcome-modal" id="welcomeModal">
    <div class="vehicle-selection">
        <h2 style="text-align: center; color: var(--primary-color);">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
        <div class="driver-info" style="margin-bottom: 2rem;">
            <input type="text" 
                   id="driverName" 
                   placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" 
                   class="search-input"
                   style="margin-bottom: 1rem; width: 100%;"
                   required>
        </div>
        <h3 style="text-align: center; color: var(--primary-color);">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3>
        <div class="vehicle-option" onclick="selectVehicle('economy')">
            <svg class="car-icon" viewBox="0 0 24 24">
                <path fill="var(--primary-color)" d="M5,11L6.5,6.5H17.5L19,11M17.5,16A1.5,1.5 0 0,1 16,14.5A1.5,1.5 0 0,1 17.5,13A1.5,1.5 0 0,1 19,14.5A1.5,1.5 0 0,1 17.5,16M6.5,16A1.5,1.5 0 0,1 5,14.5A1.5,1.5 0 0,1 6.5,13A1.5,1.5 0 0,1 8,14.5A1.5,1.5 0 0,1 6.5,16M18.92,6C18.72,5.42 18.16,5 17.5,5H6.5C5.84,5 5.28,5.42 5.08,6L3,12V20A1,1 0 0,0 4,21H5A1,1 0 0,0 6,20V19H18V20A1,1,0 0,0 19,21H20A1,1 0 0,0 21,20V12L18.92,6Z"/>
            </svg>
            <div>
                <h3>Ø±Ø­Ø§Ù„ ØªÙˆÙÙŠØ±</h3>
                <p>ØªÙƒØ³ÙŠ ØªÙˆÙÙŠØ±ØŒ Ø£Ù‚Ù„ Ù…Ø´ÙˆØ§Ø± 800 Ø±ÙŠØ§Ù„</p>
            </div>
        </div>
        <div class="vehicle-option" onclick="selectVehicle('premium')">
            <svg class="car-icon" viewBox="0 0 24 24">
                <path fill="var(--primary-color)" d="M5,11L6.5,6.5H17.5L19,11M17.5,16A1.5,1.5 0 0,1 16,14.5A1.5,1.5 0 0,1 17.5,13A1.5,1.5 0 0,1 19,14.5A1.5,1.5 0 0,1 17.5,16M6.5,16A1.5,1.5 0 0,1 5,14.5A1.5,1.5 0 0,1 6.5,13A1.5,1.5 0 0,1 8,14.5A1.5,1.5 0 0,1 6.5,16M18.92,6C18.72,5.42 18.16,5 17.5,5H6.5C5.84,5 5.28,5.42 5.08,6L3,12V20A1,1 0 0,0 4,21H5A1,1 0 0,0 6,20V19H18V20A1,1,0 0,0 19,21H20A1,1 0 0,0 21,20V12L18.92,6Z"/>
            </svg>
            <div>
                <h3>Ø±Ø­Ø§Ù„ ØªÙƒØ³ÙŠ</h3>
                <p>ØªÙƒØ³ÙŠ Ø®Ø§ØµØŒ Ø£Ù‚Ù„ Ù…Ø´ÙˆØ§Ø± 1000 Ø±ÙŠØ§Ù„</p>
            </div>
        </div>
        <div class="vehicle-option" onclick="selectVehicle('family')">
            <svg class="car-icon" viewBox="0 0 24 24">
                <path fill="var(--primary-color)" d="M3,7C1.89,7 1,7.89 1,9V17H3A3,3 0 0,0 6,20A3,3 0 0,0 9,17H15A3,3 0 0,0 18,20A3,3 0 0,0 21,17H23V13C23,11.89 22.11,11 21,11L18,7H3M3,8.5H17.5L19.46,11H3V8.5M6,15.5A1.5,1.5 0 0,1 7.5,17A1.5,1.5 0 0,1 6,18.5A1.5,1.5 0 0,1 4.5,17A1.5,1.5 0 0,1 6,15.5M18,15.5A1.5,1.5 0 0,1 19.5,17A1.5,1.5 0 0,1 18,18.5A1.5,1.5 0 0,1 16.5,17A1.5,1.5 0 0,1 18,15.5Z"/>
            </svg>
            <div>
                <h3>Ø±Ø­Ø§Ù„ Ø¹Ø§Ø¦Ù„ÙŠ</h3>
                <p>Ø¨Ø§Øµ Ù†Ù‚Ù„ Ø¹Ø§Ø¦Ù„ÙŠØŒ Ø£Ù‚Ù„ Ù…Ø´ÙˆØ§Ø± 1200 Ø±ÙŠØ§Ù„</p>
            </div>
        </div>
    </div>
</div>

<div class="location-error-modal" id="locationErrorModal">
    <div class="location-error-icon">
        <svg width="30" height="30" viewBox="0 0 24 24">
            <path fill="#FF5252" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
    </div>
    <h3 class="location-error-title">ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ</h3>
    <p class="location-error-message">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ Ù„Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø®Ø¯Ù…ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„</p>
    <button class="location-error-button" onclick="closeLocationError()">Ø­Ø³Ù†Ø§Ù‹</button>
</div>

<div id="map" class="map-container"></div>

<div class="trip-details" id="tripDetails">
    <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h3>
    <p>Ø§Ù„Ù…Ø³Ø§ÙØ©: <span id="distance">0</span> ÙƒÙ…</p>
    <p>Ø§Ù„ÙˆÙ‚Øª: <span id="time">0</span> Ø¯Ù‚ÙŠÙ‚Ø©</p>
    <p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span id="cost">0</span> Ø±ÙŠØ§Ù„</p>
    <button class="end-trip-btn" onclick="endTrip()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<div class="modal-overlay" id="modalOverlay"></div>
<div class="trip-completion-modal" id="tripCompletionModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</h2>
            <div class="completion-icon">âœ“</div>
        </div>
        <div class="modal-body">
            <div class="trip-summary">
                <div class="summary-item">
                    <span class="label">Ø§Ù„Ù…Ø³Ø§ÙØ©:</span>
                    <span class="value"><span id="finalDistance">0</span> ÙƒÙ…</span>
                </div>
                <div class="summary-item">
                    <span class="label">Ø§Ù„ÙˆÙ‚Øª:</span>
                    <span class="value"><span id="finalTime">0</span> Ø¯Ù‚ÙŠÙ‚Ø©</span>
                </div>
                <div class="summary-item total-cost">
                    <span class="label">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span>
                    <span class="value"><span id="finalCost">0</span> Ø±ÙŠØ§Ù„</span>
                </div>
            </div>
        </div>
        <button class="modal-button" onclick="closeCompletionModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div class="search-bar">
    <div class="search-container">
        <input type="search" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬Ù‡ØªÙƒ...">
        <button class="search-btn" onclick="performSearch()">Ø¨Ø­Ø«</button>
    </div>
    <div class="button-container">
        <button class="start-trip-btn" id="setLocationBtn" onclick="setStartLocation()">ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ÙƒÙ†Ù‚Ø·Ø© Ø¥Ù‚Ù„Ø§Ø¹</button>
        <button class="start-trip-btn" id="startTripBtn" onclick="startTrip()" style="display: none;">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    </div>
    <div id="tripStatus" class="trip-status" style="display: none;">
        <div class="pulse-dot"></div>
        Ø§Ù„Ø±Ø­Ù„Ø© Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†...
    </div>
</div>

<!-- Add a generic notification modal -->
<div class="notification-modal" id="notificationModal">
    <div class="modal-icon">
        <svg width="30" height="30" viewBox="0 0 24 24">
            <path fill="#FFFFFF" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
    </div>
    <h3 class="modal-title" id="modalTitle"></h3>
    <p class="modal-message" id="modalMessage"></p>
    <button class="modal-button" onclick="closeNotification()">Ø­Ø³Ù†Ø§Ù‹</button>
</div>

<!-- Add Leaflet JS and Algolia Places JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<!-- Add Leaflet Rotate Plugin -->
<script src="https://unpkg.com/leaflet-rotate@0.1.4/dist/leaflet-rotate.js"></script>

<script>
let map;
let selectedVehicleType;
let startMarker;
let destinationMarker;
let routingControl;
let tripStartTime;
let tripInterval;
let watchId; // For tracking geolocation
let totalDistance = 0;
let lastPosition = null;
let trackingPath;

let isTracking = false;
let trackPolyline = null;

const startIcon = L.divIcon({
    html: `<svg width="30" height="30" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" fill="#4CAF50" stroke="white" stroke-width="2"/>
        <circle cx="12" cy="12" r="5" fill="white"/>
    </svg>`,
    className: 'custom-div-icon'
});

const destinationIcon = L.divIcon({
    html: `<svg width="30" height="30" viewBox="0 0 24 24">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" 
              fill="#FF5252" stroke="white" stroke-width="2"/>
        <circle cx="12" cy="9" r="3" fill="white"/>
    </svg>`,
    className: 'custom-div-icon'
});

const vehicleIcon = L.divIcon({
    html: `<svg width="30" height="30" viewBox="0 0 24 24">
        <path d="M18.92 6c-.2-.58-.76-1-1.42-1h-11c-.66 0-1.22.42-1.42 1l-2.08 6v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-6z" 
              fill="#2196F3" stroke="white" stroke-width="2"/>
    </svg>`,
    className: 'custom-div-icon'
});

// Initialize map first
initMap();

function initMap() {
    try {
        // Initialize Leaflet map with rotation enabled
        map = L.map('map', {
            zoomControl: true,
            minZoom: 3,
            maxZoom: 18,
            rotate: true, // Enable rotation
            rotateControl: true // Add rotation control
        }).setView([24.7136, 46.6753], 12);
        
        // Add OpenStreetMap tiles with error handling
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø®Ø§Ù„Ø¯ Ø§Ù„ØºÙŠÙ„ÙŠ',
            errorTileUrl: 'https://via.placeholder.com/256x256.png?text=Map+Tile+Error'
        }).addTo(map);

        // Add rotation control
        L.control.rotate({
            position: 'topright',
            closeOnZeroBearing: false
        }).addTo(map);

        // Add click event to map for destination selection
        map.on('click', function(e) {
            try {
                const clickedPos = e.latlng;
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }
                destinationMarker = L.marker(clickedPos, {icon: destinationIcon}).addTo(map);
                calculateRoute();
            } catch (err) {
                console.error('Error handling map click:', err);
            }
        });
    } catch (err) {
        console.error('Error initializing map:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
    }
}

function selectVehicle(type) {
    const driverName = document.getElementById('driverName').value.trim();
    
    if (!driverName) {
        showNotification('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©');
        return;
    }

    selectedVehicleType = type;
    localStorage.setItem('vehicleType', type);
    localStorage.setItem('driverName', driverName);
    document.getElementById('welcomeModal').style.display = 'none';
    
    // Request location permission after vehicle selection
    requestLocation();
}

function requestLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const pos = [position.coords.latitude, position.coords.longitude];
                map.setView(pos, 15);
                if (startMarker) map.removeLayer(startMarker);
                startMarker = L.marker(pos, {icon: vehicleIcon}).addTo(map);
            },
            () => {
                // Show custom error modal instead of alert
                document.getElementById('locationErrorModal').style.display = 'block';
            }
        );
    } else {
        // Show custom error modal for unsupported browsers
        document.getElementById('locationErrorModal').style.display = 'block';
        document.querySelector('.location-error-message').textContent = 
            'Ù…ØªØµÙØ­Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Ø­Ø¯ÙŠØ«.';
    }
}

// Add this function after the calculateHaversineDistance function
function setStartLocation() {
    // Request location permission
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const pos = [position.coords.latitude, position.coords.longitude];
                
                // Update or create start marker
                if (startMarker) {
                    map.removeLayer(startMarker);
                }
                startMarker = L.marker(pos, {icon: vehicleIcon}).addTo(map);
                
                // Center map on position
                map.setView(pos, 15);
                
                // Show start trip button
                document.getElementById('setLocationBtn').style.display = 'none';
                document.getElementById('startTripBtn').style.display = 'block';
                
                // Calculate route if destination exists
                if (destinationMarker) {
                    calculateRoute();
                }
            },
            error => {
                handleLocationError(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    } else {
        showNotification('ØªÙ†Ø¨ÙŠÙ‡', 'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹');
    }
}

// Add this new function to send message to Telegram bot
async function sendTripDetailsToTelegram(tripDetails) {
  const botToken = '7524355853:AAHhBzEKIjr9W_BjPHLkoc41f4HqQwl5ydg';
  const chatId = '6526965796';
  
  // Format date/time
  const now = new Date();
  const dateStr = now.toLocaleDateString('ar-SA');
  const timeStr = now.toLocaleTimeString('ar-SA');

  // Get saved driver details
  const driverName = localStorage.getItem('driverName') || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const vehicleType = localStorage.getItem('vehicleType') || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  
  // Convert vehicle type to Arabic
  let vehicleArabic;
  switch(vehicleType) {
    case 'economy': vehicleArabic = 'Ø±Ø­Ø§Ù„ ØªÙˆÙÙŠØ±'; break;
    case 'premium': vehicleArabic = 'Ø±Ø­Ø§Ù„ ØªÙƒØ³ÙŠ'; break; 
    case 'family': vehicleArabic = 'Ø±Ø­Ø§Ù„ Ø¹Ø§Ø¦Ù„ÙŠ'; break;
    default: vehicleArabic = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  }

  // Format message
  const message = `
ğŸš– ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:

ğŸ‘¨â€âœˆï¸ Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driverName}
ğŸš— Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${vehicleArabic}
ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: ${tripDetails.distance} ÙƒÙ…
â± Ø§Ù„ÙˆÙ‚Øª: ${tripDetails.time} Ø¯Ù‚ÙŠÙ‚Ø©
ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ©: ${tripDetails.cost} Ø±ÙŠØ§Ù„

ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}
â° Ø§Ù„ÙˆÙ‚Øª: ${timeStr}
`;

  try {
    const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        chat_id: chatId,
        text: message,
        parse_mode: 'HTML'
      })
    });

    const data = await response.json();
    if (!data.ok) {
      console.error('Error sending to Telegram:', data);
    }
  } catch (err) {
    console.error('Failed to send message to Telegram:', err);
  }
}

// Update the endTrip function to include Telegram notification
function endTrip() {
    // Stop location tracking
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
    }
    
    clearInterval(tripInterval);
    const tripDetails = {
        distance: totalDistance.toFixed(2),
        time: document.getElementById('time').textContent,
        cost: document.getElementById('cost').textContent
    };

    // Update modal display
    document.getElementById('finalCost').textContent = tripDetails.cost;
    document.getElementById('finalDistance').textContent = tripDetails.distance;
    document.getElementById('finalTime').textContent = tripDetails.time;
    document.getElementById('modalOverlay').style.display = 'block';
    document.getElementById('tripCompletionModal').style.display = 'block';
    document.getElementById('tripDetails').style.display = 'none';
    
    // Send trip details to Telegram
    sendTripDetailsToTelegram(tripDetails);
    
    // Reset UI
    document.getElementById('setLocationBtn').style.display = 'block';
    document.getElementById('tripStatus').style.display = 'none';
    totalDistance = 0;
    lastPosition = null;
}

// Update the clearMapData function to safely clear map elements
function clearMapData() {
    try {
        // Remove markers with null checks
        if (startMarker && map) {
            map.removeLayer(startMarker);
            startMarker = null;
        }
        if (destinationMarker && map) {
            map.removeLayer(destinationMarker);
            destinationMarker = null;
        }
        
        // Remove routing control with null check
        if (routingControl && map) {
            map.removeControl(routingControl);
            routingControl = null;
        }
        
        // Remove tracking polyline with null check
        if (trackPolyline && map) {
            map.removeLayer(trackPolyline);
            trackPolyline = null;
        }

        // Reset variables
        isTracking = false;
        totalDistance = 0;
        lastPosition = null;
        tripStartTime = null;
        
        // Reset UI elements with null checks
        const setLocationBtn = document.getElementById('setLocationBtn');
        const startTripBtn = document.getElementById('startTripBtn');
        const tripStatus = document.getElementById('tripStatus');
        const tripDetails = document.getElementById('tripDetails');
        const searchInput = document.getElementById('searchInput');
        
        if (setLocationBtn) setLocationBtn.style.display = 'block';
        if (startTripBtn) startTripBtn.style.display = 'none';
        if (tripStatus) tripStatus.style.display = 'none';
        if (tripDetails) tripDetails.style.display = 'none';
        if (searchInput) searchInput.value = '';

    } catch (err) {
        console.error('Error in clearMapData:', err);
    }
}

// Update the closeCompletionModal function with error handling
function closeCompletionModal() {
    try {
        const modalOverlay = document.getElementById('modalOverlay');
        const tripCompletionModal = document.getElementById('tripCompletionModal');
        
        if (modalOverlay) modalOverlay.style.display = 'none';
        if (tripCompletionModal) tripCompletionModal.style.display = 'none';
        
        clearMapData();
    } catch (err) {
        console.error('Error in closeCompletionModal:', err);
    }
}

// Also modify handleLocationError function
function handleLocationError(error) {
    console.error('Error getting location:', error);
    // Show custom error modal instead of alert
    document.getElementById('locationErrorModal').style.display = 'block';
}

function calculateRoute() {
    if (!startMarker || !destinationMarker) {
        return;
    }
    
    try {
        // Safely remove existing routing control
        if (routingControl) {
            try {
                map.removeControl(routingControl);
            } catch (err) {
                console.warn('Error removing previous route:', err);
            }
        }
        
        // Create new routing control with error handling
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(startMarker.getLatLng()),
                L.latLng(destinationMarker.getLatLng())
            ],
            lineOptions: {
                styles: [
                    {color: '#2196F3', opacity: 0.8, weight: 6},
                    {color: '#FFF', opacity: 0.3, weight: 10}
                ]
            },
            createMarker: function(i, wp) {
                return L.marker(wp.latLng, {
                    icon: i === 0 ? startIcon : destinationIcon
                });
            },
            showAlternatives: false,
            fitSelectedRoutes: false,
            addWaypoints: false,
            draggableWaypoints: false,
            show: false
        });

        // Add route control to map with error catching
        try {
            routingControl.addTo(map);
        } catch (err) {
            console.error('Error adding route to map:', err);
            drawFallbackLine();
            return;
        }

        routingControl.on('routingerror', function(e) {
            console.error('Routing error:', e);
            drawFallbackLine();
        });
        
        routingControl.on('routesfound', function(e) {
            try {
                const routes = e.routes;
                if (routes && routes[0]) {
                    const route = routes[0];
                    const distance = route.summary.totalDistance / 1000;
                    document.getElementById('distance').textContent = distance.toFixed(2);
                    updateCost();
                }
            } catch (err) {
                console.error('Error processing route:', err);
                drawFallbackLine();
            }
        });
    } catch (err) {
        console.error('Error in calculateRoute:', err);
        drawFallbackLine();
    }
}

// Add this fallback function to draw a simple line between points
function drawFallbackLine() {
    try {
        // Clean up any existing routing control
        if (routingControl) {
            try {
                map.removeControl(routingControl);
            } catch (err) {
                console.warn('Error removing routing control:', err);
            }
            routingControl = null;
        }
        
        // Clean up existing fallback line
        if (window.fallbackLine) {
            try {
                map.removeLayer(window.fallbackLine);
            } catch (err) {
                console.warn('Error removing fallback line:', err);
            }
        }
        
        // Draw new line if we have both markers
        if (startMarker && destinationMarker) {
            const latlngs = [
                startMarker.getLatLng(),
                destinationMarker.getLatLng()
            ];
            
            window.fallbackLine = L.polyline(latlngs, {
                color: '#8B0000',
                opacity: 0.8,
                weight: 6
            }).addTo(map);
            
            const distance = startMarker.getLatLng().distanceTo(destinationMarker.getLatLng()) / 1000;
            document.getElementById('distance').textContent = distance.toFixed(2);
            updateCost();
        }
    } catch (err) {
        console.error('Error in drawFallbackLine:', err);
    }
}

function updateTripTime() {
    if (!tripStartTime) return;
    
    const now = new Date();
    const diff = now - tripStartTime;
    const minutes = Math.floor(diff / 60000); // Convert milliseconds to minutes
    document.getElementById('time').textContent = minutes;
    updateCost();
}

function getMinimumFare() {
    switch(selectedVehicleType) {
        case 'economy': return '800';
        case 'premium': return '1000';
        case 'family': return '1200';
        default: return '800';
    }
}

function updateCost() {
    const ratePerKm = 200; // Fixed rate per km
    const ratePerMinute = 10; // Fixed rate per minute
    
    let minimumFare;
    switch(selectedVehicleType) {
        case 'economy':
            minimumFare = 800;
            break;
        case 'premium':
            minimumFare = 1000;
            break;
        case 'family':
            minimumFare = 1200;
            break;
        default:
            minimumFare = 800;
    }

    const distance = parseFloat(document.getElementById('distance').textContent) || 0;
    const minutes = parseInt(document.getElementById('time').textContent) || 0;

    // Calculate fare from zero
    const calculatedFare = (distance * ratePerKm) + (minutes * ratePerMinute);
    
    // Use minimum fare if calculated fare is lower
    const finalCost = Math.max(calculatedFare, minimumFare);
    document.getElementById('cost').textContent = Math.round(finalCost);
}

function startTrip() {
    if (!startMarker) {
        showNotification('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }
    
    isTracking = true;
    
    // Hide buttons and show trip status
    document.getElementById('setLocationBtn').style.display = 'none';
    document.getElementById('startTripBtn').style.display = 'none';
    document.getElementById('tripStatus').style.display = 'flex';
    
    // Initialize tracking polyline
    if (trackPolyline) {
        map.removeLayer(trackPolyline);
    }
    trackPolyline = L.polyline([], {
        color: '#4CAF50',
        weight: 4,
        dashArray: '10,10',
        opacity: 0.8
    }).addTo(map);
    
    // Show trip details panel
    tripStartTime = new Date();
    document.getElementById('tripDetails').style.display = 'block';
    
    // Initialize trip details
    document.getElementById('distance').textContent = '0.00';
    document.getElementById('time').textContent = '0';
    document.getElementById('cost').textContent = getMinimumFare();
    
    // Start updating trip time
    if (tripInterval) {
        clearInterval(tripInterval);
    }
    tripInterval = setInterval(updateTripTime, 1000);
    
    // Start location tracking
    if (navigator.geolocation) {
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }
        watchId = navigator.geolocation.watchPosition(
            updatePosition,
            handleLocationError,
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            }
        );
    }
}

function updatePosition(position) {
    const currentPos = [position.coords.latitude, position.coords.longitude];
    
    if (isTracking) {
        // Update vehicle marker with smooth animation
        if (startMarker) {
            startMarker.setLatLng(currentPos);
            startMarker.setIcon(vehicleIcon);
        }
        
        // Update tracking path
        if (trackPolyline) {
            trackPolyline.addLatLng(currentPos);
        }
        
        // Calculate actual distance traveled
        if (lastPosition) {
            const newDistance = calculateHaversineDistance(
                lastPosition[0], lastPosition[1],
                currentPos[0], currentPos[1]
            );
            totalDistance += newDistance;
            document.getElementById('distance').textContent = totalDistance.toFixed(2);
            updateCost();
        }
        
        lastPosition = currentPos;
        
        // Center map on vehicle with smooth animation
        map.panTo(currentPos, {
            animate: true,
            duration: 1
        });
    }
}

function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function toRad(degrees) {
    return degrees * (Math.PI/180);
}

// Update the existing window.onload function
window.onload = () => {
    try {
        const savedVehicleType = localStorage.getItem('vehicleType');
        const savedDriverName = localStorage.getItem('driverName');
        
        if (savedVehicleType && savedDriverName) {
            const driverNameInput = document.getElementById('driverName');
            if (driverNameInput) {
                driverNameInput.value = savedDriverName;
            }
            selectVehicle(savedVehicleType);
        }
        
        // Initialize search with error handling
        initializeSearch();
        
    } catch (err) {
        console.error('Error in window.onload:', err);
    }
};

// Update initializeSearch with better error handling
function initializeSearch() {
    try {
        const searchInput = document.getElementById('searchInput');
        if (!searchInput) {
            console.error('Search input element not found');
            return;
        }

        const resultsContainer = document.createElement('div');
        resultsContainer.id = 'searchResults';
        resultsContainer.className = 'search-results';
        searchInput.parentNode.appendChild(resultsContainer);

        let timeoutId = null;
        
        searchInput.addEventListener('input', function(e) {
            if (timeoutId) clearTimeout(timeoutId);
            
            timeoutId = setTimeout(() => {
                const query = e.target.value;
                if (!query || query.length < 3) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                // Search API call with error handling
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=sa&limit=5&accept-language=ar`)
                    .then(response => response.json())
                    .then(data => {
                        if (!resultsContainer) return;
                        
                        resultsContainer.innerHTML = '';
                        resultsContainer.style.display = data.length ? 'block' : 'none';
                        
                        data.forEach(result => {
                            if (!result) return;
                            
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `
                                <svg class="location-icon" viewBox="0 0 24 24" width="20" height="20">
                                    <path fill="#8B0000" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                                </svg>
                                <span>${result.display_name}</span>
                            `;
                            
                            item.addEventListener('click', () => {
                                if (!searchInput || !resultsContainer) return;
                                
                                searchInput.value = result.display_name;
                                resultsContainer.style.display = 'none';
                                
                                const coords = [parseFloat(result.lat), parseFloat(result.lon)];
                                if (destinationMarker && map) map.removeLayer(destinationMarker);
                                
                                destinationMarker = L.marker(coords, {icon: destinationIcon}).addTo(map);
                                if (map) map.setView(coords, 15);
                                calculateRoute();
                            });
                            
                            resultsContainer.appendChild(item);
                        });
                    })
                    .catch(err => console.error('Search error:', err));
            }, 300);
        });

    } catch (err) {
        console.error('Error in initializeSearch:', err);
    }
}

// Add this to your existing showNotification function
function showNotification(title, message) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('notificationModal').style.display = 'block';
}

function closeNotification() {
    document.getElementById('notificationModal').style.display = 'none';
}

function performSearch() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput.value || searchInput.value.length < 3) {
        showNotification('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«');
        return;
    }

    // Show loading indicator
    showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...', 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');

    // Perform search using OpenStreetMap Nominatim API
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchInput.value)}&countrycodes=sa&limit=5&accept-language=ar`)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                // Use first result
                const location = data[0];
                const coords = [parseFloat(location.lat), parseFloat(location.lon)];

                // Update destination marker
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }
                destinationMarker = L.marker(coords, {icon: destinationIcon}).addTo(map);

                // Pan and zoom to location
                map.setView(coords, 15, {
                    animate: true,
                    duration: 1
                });

                // Calculate route
                calculateRoute();

                // Close notification
                closeNotification();
            } else {
                showNotification('Ø¹Ø°Ø±Ø§Ù‹', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«');
            }
        })
        .catch(err => {
            console.error('Search error:', err);
            showNotification('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«');
        });
}
</script>
</body></html>
